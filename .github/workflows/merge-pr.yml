name: Auto Merge Pull Requests
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  auto_merge:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      checks: read
      statuses: read
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}

      - name: Set up Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Enhanced PR Diagnosis and Auto-merge
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ” Getting all open pull requests..."
          
          # éªŒè¯ GitHub CLI è®¤è¯
          echo "ğŸ” Checking GitHub CLI authentication..."
          gh auth status
          
          # è·å–æ‰€æœ‰å¼€æ”¾çš„PR
          prs=$(gh pr list --state open --json number,title,headRefName,author,baseRefName,url)
          
          if [[ "$prs" == "[]" ]]; then
            echo "â„¹ï¸ No open pull requests found."
            exit 0
          fi
          
          echo "ğŸ“‹ Found $(echo "$prs" | jq length) open PR(s)"
          
          # éå†æ¯ä¸ªPR
          echo "$prs" | jq -c '.[]' | while read -r pr; do
            pr_number=$(echo "$pr" | jq -r '.number')
            pr_title=$(echo "$pr" | jq -r '.title')
            pr_author=$(echo "$pr" | jq -r '.author.login')
            head_branch=$(echo "$pr" | jq -r '.headRefName')
            base_branch=$(echo "$pr" | jq -r '.baseRefName')
            pr_url=$(echo "$pr" | jq -r '.url')
            
            echo "================================================"
            echo "ğŸ”„ Processing PR #$pr_number: $pr_title"
            echo "ğŸ‘¤ Author: $pr_author"
            echo "ğŸŒ¿ Branch: $head_branch â†’ $base_branch"
            echo "ğŸ”— URL: $pr_url"
            
            # è·å–è¯¦ç»†çš„PRçŠ¶æ€ä¿¡æ¯
            echo "ğŸ” Getting detailed PR status..."
            pr_status=$(gh pr view $pr_number --json mergeable,reviewDecision,statusCheckRollup,commits)
            mergeable=$(echo "$pr_status" | jq -r '.mergeable')
            review_decision=$(echo "$pr_status" | jq -r '.reviewDecision // "NONE"')
            
            echo "ğŸ“Š Basic Status:"
            echo "   â€¢ Mergeable: $mergeable"
            echo "   â€¢ Review decision: $review_decision"
            
            # è¯¦ç»†æ£€æŸ¥çŠ¶æ€æ£€æŸ¥
            echo "ğŸ§ª Analyzing status checks in detail..."
            
            # æ–¹æ³•1ï¼šé€šè¿‡ statusCheckRollup æ£€æŸ¥
            status_checks=$(echo "$pr_status" | jq -r '.statusCheckRollup // []')
            if [[ "$status_checks" != "[]" ]] && [[ "$status_checks" != "null" ]]; then
              echo "   ğŸ“ Status Check Rollup:"
              echo "$status_checks" | jq -r '.[] | "   - \(.name // .context): \(.conclusion // .state) (\(.targetUrl // "no URL"))"'
              
              # ç»Ÿè®¡å¤±è´¥çš„æ£€æŸ¥
              failed_checks=$(echo "$status_checks" | jq -r '.[] | select((.conclusion // .state) | test("FAILURE|ERROR|CANCELLED"; "i")) | .name // .context')
              pending_checks=$(echo "$status_checks" | jq -r '.[] | select((.conclusion // .state) | test("PENDING|IN_PROGRESS"; "i")) | .name // .context')
              
              if [[ -n "$failed_checks" ]]; then
                echo "   âŒ Failed checks:"
                echo "$failed_checks" | while IFS= read -r check; do
                  [[ -n "$check" ]] && echo "      - $check"
                done
              fi
              
              if [[ -n "$pending_checks" ]]; then
                echo "   â³ Pending checks:"
                echo "$pending_checks" | while IFS= read -r check; do
                  [[ -n "$check" ]] && echo "      - $check"
                done
              fi
            fi
            
            # æ–¹æ³•2ï¼šä½¿ç”¨ gh pr checks å‘½ä»¤è·å–æ›´è¯¦ç»†ä¿¡æ¯
            echo "   ğŸ”¬ Detailed checks via gh pr checks:"
            pr_checks_output=$(gh pr checks $pr_number --json name,conclusion,detailsUrl,summary 2>/dev/null || echo "[]")
            
            if [[ "$pr_checks_output" != "[]" ]] && [[ "$pr_checks_output" != "null" ]]; then
              echo "$pr_checks_output" | jq -r '.[] | "   - \(.name): \(.conclusion // "UNKNOWN") (\(.detailsUrl // "no URL"))"'
              
              # è·å–å¤±è´¥çš„è¯¦ç»†ä¿¡æ¯
              failed_detailed=$(echo "$pr_checks_output" | jq -r '.[] | select(.conclusion | test("FAILURE|ERROR|CANCELLED"; "i")) | "      âŒ \(.name): \(.summary // "No summary available")"')
              if [[ -n "$failed_detailed" ]]; then
                echo "   ğŸ“‹ Failed check details:"
                echo "$failed_detailed"
              fi
            else
              echo "   â„¹ï¸ No detailed checks available via gh pr checks"
            fi
            
            # æ–¹æ³•3ï¼šé€šè¿‡ API è·å–æ›´å¤šä¿¡æ¯
            echo "   ğŸ” Getting commit status via API..."
            latest_commit=$(echo "$pr_status" | jq -r '.commits[-1].oid // empty')
            
            if [[ -n "$latest_commit" ]]; then
              echo "   Latest commit: $latest_commit"
              
              # è·å– commit çŠ¶æ€
              commit_status=$(gh api repos/:owner/:repo/commits/$latest_commit/status --jq '.state, .statuses[]?' 2>/dev/null || echo "")
              if [[ -n "$commit_status" ]]; then
                echo "   ğŸ“¡ Commit status API response:"
                echo "$commit_status" | head -20  # é™åˆ¶è¾“å‡ºé•¿åº¦
              fi
              
              # è·å– check runs
              check_runs=$(gh api repos/:owner/:repo/commits/$latest_commit/check-runs --jq '.check_runs[]?' 2>/dev/null || echo "")
              if [[ -n "$check_runs" ]]; then
                echo "   ğŸƒ Check runs:"
                echo "$check_runs" | jq -r 'select(.conclusion != "success") | "      \(.name): \(.conclusion) - \(.output.summary // "No summary")"' | head -10
              fi
            fi
            
            # è®¡ç®—æ€»ä½“çŠ¶æ€
            all_checks_passed=true
            has_pending=false
            
            # ä»å¤šä¸ªæ¥æºç»¼åˆåˆ¤æ–­
            if [[ "$status_checks" != "[]" ]] && [[ "$status_checks" != "null" ]]; then
              if echo "$status_checks" | jq -e '.[] | select((.conclusion // .state) | test("FAILURE|ERROR|CANCELLED"; "i"))' >/dev/null 2>&1; then
                all_checks_passed=false
              fi
              if echo "$status_checks" | jq -e '.[] | select((.conclusion // .state) | test("PENDING|IN_PROGRESS"; "i"))' >/dev/null 2>&1; then
                has_pending=true
              fi
            fi
            
            if [[ "$pr_checks_output" != "[]" ]] && [[ "$pr_checks_output" != "null" ]]; then
              if echo "$pr_checks_output" | jq -e '.[] | select(.conclusion | test("FAILURE|ERROR|CANCELLED"; "i"))' >/dev/null 2>&1; then
                all_checks_passed=false
              fi
            fi
            
            echo "ğŸ“Š Final Status Summary:"
            echo "   â€¢ Mergeable: $mergeable"
            echo "   â€¢ All checks passed: $all_checks_passed"
            echo "   â€¢ Has pending checks: $has_pending"
            echo "   â€¢ Review decision: $review_decision"
            
            # å†³å®šæ˜¯å¦åˆå¹¶
            can_merge=false
            
            if [[ "$mergeable" == "MERGEABLE" ]] && [[ "$all_checks_passed" == true ]] && [[ "$has_pending" == false ]]; then
              case "$review_decision" in
                "APPROVED"|"NONE"|"null")
                  can_merge=true
                  ;;
                *)
                  echo "   â¸ï¸ Cannot merge: Review decision is $review_decision"
                  ;;
              esac
            fi
            
            if [[ "$can_merge" == true ]]; then
              echo "âœ… PR #$pr_number is ready for merge!"
              
              # æ£€æŸ¥åˆ†æ”¯ä¿æŠ¤å’Œåˆå¹¶ç­–ç•¥
              echo "ğŸ”„ Attempting to merge PR #$pr_number..."
              
              # å°è¯•ä¸åŒçš„åˆå¹¶ç­–ç•¥
              merge_success=false
              
              # 1. å°è¯• squash merge ï¼ˆæ¨èï¼‰
              echo "   Trying squash merge..."
              if gh pr merge $pr_number --squash --delete-branch 2>/dev/null; then
                echo "ğŸ‰ Successfully squash merged PR #$pr_number and deleted branch"
                merge_success=true
              elif gh pr merge $pr_number --squash 2>/dev/null; then
                echo "ğŸ‰ Successfully squash merged PR #$pr_number (branch not deleted)"
                merge_success=true
              else
                echo "   âŒ Squash merge failed"
              fi
              
              # 2. å¦‚æœ squash å¤±è´¥ï¼Œå°è¯• merge commit
              if [[ "$merge_success" == false ]]; then
                echo "   Trying merge commit..."
                if gh pr merge $pr_number --merge --delete-branch 2>/dev/null; then
                  echo "ğŸ‰ Successfully merge committed PR #$pr_number and deleted branch"
                  merge_success=true
                elif gh pr merge $pr_number --merge 2>/dev/null; then
                  echo "ğŸ‰ Successfully merge committed PR #$pr_number (branch not deleted)"
                  merge_success=true
                else
                  echo "   âŒ Merge commit failed"
                fi
              fi
              
              # 3. å¦‚æœéƒ½å¤±è´¥ï¼Œå°è¯• rebase
              if [[ "$merge_success" == false ]]; then
                echo "   Trying rebase merge..."
                if gh pr merge $pr_number --rebase --delete-branch 2>/dev/null; then
                  echo "ğŸ‰ Successfully rebased PR #$pr_number and deleted branch"
                  merge_success=true
                elif gh pr merge $pr_number --rebase 2>/dev/null; then
                  echo "ğŸ‰ Successfully rebased PR #$pr_number (branch not deleted)"
                  merge_success=true
                else
                  echo "   âŒ Rebase merge failed"
                fi
              fi
              
              if [[ "$merge_success" == false ]]; then
                echo "âŒ All merge attempts failed for PR #$pr_number"
                echo "ğŸ’¡ This might be due to:"
                echo "   - Insufficient permissions"
                echo "   - Branch protection rules"
                echo "   - Merge conflicts"
                echo "   - Required status checks not meeting branch protection requirements"
                
                # è·å–åˆ†æ”¯ä¿æŠ¤ä¿¡æ¯
                echo "ğŸ›¡ï¸ Checking branch protection rules..."
                protection_info=$(gh api repos/:owner/:repo/branches/$base_branch/protection 2>/dev/null || echo "No protection rules found")
                echo "$protection_info" | head -10
              fi
              
            else
              echo "â¸ï¸ PR #$pr_number is not ready for auto-merge"
              
              # è¯¦ç»†çš„é˜»å¡åŸå› åˆ†æ
              echo "ğŸš« Blocking reasons:"
              
              if [[ "$mergeable" != "MERGEABLE" ]]; then
                case "$mergeable" in
                  "CONFLICTING")
                    echo "   ğŸ”´ Merge conflicts detected - manual resolution required"
                    ;;
                  "UNKNOWN")
                    echo "   ğŸŸ¡ Merge status unknown - GitHub may still be calculating"
                    ;;
                  *)
                    echo "   ğŸ”´ Not mergeable: $mergeable"
                    ;;
                esac
              fi
              
              if [[ "$all_checks_passed" != true ]]; then
                echo "   ğŸ”´ Some status checks are failing - see details above"
              fi
              
              if [[ "$has_pending" == true ]]; then
                echo "   ğŸŸ¡ Some status checks are still pending"
              fi
              
              case "$review_decision" in
                "REVIEW_REQUIRED")
                  echo "   ğŸ”´ Review required but not provided"
                  ;;
                "CHANGES_REQUESTED")
                  echo "   ğŸ”´ Changes have been requested"
                  ;;
              esac
            fi
            
            echo "================================================"
          done
