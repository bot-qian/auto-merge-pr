name: Auto Merge Pull Requests
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  auto_merge:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      checks: read
      statuses: read
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}

      - name: Set up Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Smart Auto-merge with Self-check Exclusion
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          echo "üîç Getting all open pull requests..."
          
          # Ëé∑ÂèñÂΩìÂâçÂ∑•‰ΩúÊµÅËøêË°å‰ø°ÊÅØ
          CURRENT_WORKFLOW_NAME="auto_merge"
          CURRENT_RUN_ID="${{ github.run_id }}"
          
          echo "üîß Current workflow: $CURRENT_WORKFLOW_NAME (Run ID: $CURRENT_RUN_ID)"
          
          # Ëé∑ÂèñÊâÄÊúâÂºÄÊîæÁöÑPR
          prs=$(gh pr list --state open --json number,title,headRefName,author,baseRefName,url)
          
          if [[ "$prs" == "[]" ]]; then
            echo "‚ÑπÔ∏è No open pull requests found."
            exit 0
          fi
          
          echo "üìã Found $(echo "$prs" | jq length) open PR(s)"
          
          # ÈÅçÂéÜÊØè‰∏™PR
          echo "$prs" | jq -c '.[]' | while read -r pr; do
            pr_number=$(echo "$pr" | jq -r '.number')
            pr_title=$(echo "$pr" | jq -r '.title')
            pr_author=$(echo "$pr" | jq -r '.author.login')
            head_branch=$(echo "$pr" | jq -r '.headRefName')
            base_branch=$(echo "$pr" | jq -r '.baseRefName')
            pr_url=$(echo "$pr" | jq -r '.url')
            
            echo "================================================"
            echo "üîÑ Processing PR #$pr_number: $pr_title"
            echo "üë§ Author: $pr_author"
            echo "üåø Branch: $head_branch ‚Üí $base_branch"
            echo "üîó URL: $pr_url"
            
            # Ëé∑ÂèñËØ¶ÁªÜÁöÑPRÁä∂ÊÄÅ‰ø°ÊÅØ
            echo "üîç Getting detailed PR status..."
            pr_status=$(gh pr view $pr_number --json mergeable,reviewDecision,statusCheckRollup,commits)
            mergeable=$(echo "$pr_status" | jq -r '.mergeable')
            review_decision=$(echo "$pr_status" | jq -r '.reviewDecision // "NONE"')
            
            echo "üìä Basic Status:"
            echo "   ‚Ä¢ Mergeable: $mergeable"
            echo "   ‚Ä¢ Review decision: $review_decision"
            
            # Êô∫ËÉΩÁä∂ÊÄÅÊ£ÄÊü•ÔºöÊéíÈô§Ëá™Ë∫´Â∑•‰ΩúÊµÅ
            echo "üß™ Analyzing status checks (excluding self-reference)..."
            
            status_checks=$(echo "$pr_status" | jq -r '.statusCheckRollup // []')
            all_checks_passed=true
            relevant_failed_checks=""
            
            if [[ "$status_checks" != "[]" ]] && [[ "$status_checks" != "null" ]]; then
              echo "   üìù All Status Checks:"
              echo "$status_checks" | jq -r '.[] | "   - \(.name // .context): \(.conclusion // .state)"'
              
              # ËøáÊª§ÊéâËá™Ë∫´Â∑•‰ΩúÊµÅÁöÑÊ£ÄÊü•
              filtered_checks=$(echo "$status_checks" | jq -r --arg workflow "$CURRENT_WORKFLOW_NAME" '
                .[] | select((.name // .context) != $workflow) | 
                select((.conclusion // .state) | test("FAILURE|ERROR|CANCELLED"; "i")) | 
                .name // .context
              ')
              
              echo "   üîç Relevant failed checks (excluding self):"
              if [[ -n "$filtered_checks" ]] && [[ "$filtered_checks" != "" ]]; then
                echo "$filtered_checks" | while IFS= read -r check; do
                  [[ -n "$check" ]] && echo "      ‚ùå $check"
                done
                all_checks_passed=false
                relevant_failed_checks="$filtered_checks"
              else
                echo "      ‚úÖ No relevant failed checks found"
              fi
              
              # Ê£ÄÊü•ÊòØÂê¶Âè™ÊúâËá™Ë∫´Â∑•‰ΩúÊµÅÂ§±Ë¥•
              self_check_status=$(echo "$status_checks" | jq -r --arg workflow "$CURRENT_WORKFLOW_NAME" '
                .[] | select((.name // .context) == $workflow) | .conclusion // .state
              ')
              
              if [[ -n "$self_check_status" ]]; then
                echo "   üìã Self-workflow status: $self_check_status"
                if [[ "$self_check_status" =~ ^(FAILURE|ERROR|CANCELLED)$ ]]; then
                  echo "   üí° Self-workflow is failing, but this is expected for this run"
                fi
              fi
            else
              echo "   ‚ÑπÔ∏è No status checks found"
            fi
            
            # È¢ùÂ§ñÊ£ÄÊü•Ôºö‰ΩøÁî® gh pr checks ‰ΩÜÊéíÈô§Ëá™Ë∫´
            pr_checks_output=$(gh pr checks $pr_number --json name,conclusion,detailsUrl 2>/dev/null || echo "[]")
            if [[ "$pr_checks_output" != "[]" ]] && [[ "$pr_checks_output" != "null" ]]; then
              echo "   üî¨ Detailed checks (via gh pr checks):"
              echo "$pr_checks_output" | jq -r --arg workflow "$CURRENT_WORKFLOW_NAME" '
                .[] | select(.name != $workflow) | "   - \(.name): \(.conclusion // "UNKNOWN")"
              '
              
              # Ëé∑ÂèñÈô§Ëá™Ë∫´Â§ñÁöÑÂ§±Ë¥•Ê£ÄÊü•
              additional_failed=$(echo "$pr_checks_output" | jq -r --arg workflow "$CURRENT_WORKFLOW_NAME" '
                .[] | select(.name != $workflow) | 
                select(.conclusion | test("FAILURE|ERROR|CANCELLED"; "i")) | .name
              ')
              
              if [[ -n "$additional_failed" ]] && [[ "$additional_failed" != "" ]]; then
                all_checks_passed=false
                relevant_failed_checks="$relevant_failed_checks"$'\n'"$additional_failed"
              fi
            fi
            
            # Â§ÑÁêÜ UNKNOWN Áä∂ÊÄÅÁöÑÁâπÊÆäÊÉÖÂÜµ
            force_merge=false
            if [[ "$mergeable" == "UNKNOWN" ]] && [[ "$all_checks_passed" == true ]]; then
              echo "   ü§î Mergeable status is UNKNOWN but no relevant checks are failing"
              echo "   üí≠ This might be a timing issue or self-reference problem"
              
              # Ê£ÄÊü•ÊòØÂê¶ÊòØËá™Âä®Êõ¥Êñ∞ PRÔºàÂü∫‰∫éÊ†áÈ¢òÂíå‰ΩúËÄÖÔºâ
              if [[ "$pr_title" =~ ^ü§ñ.*Automated.*Update ]] || [[ "$pr_author" == "xuqssq" ]]; then
                echo "   ü§ñ Detected automated update PR"
                echo "   ‚ö° Will attempt force merge due to self-reference issue"
                force_merge=true
                mergeable="MERGEABLE"  # Âº∫Âà∂ËÆæÁΩÆ‰∏∫ÂèØÂêàÂπ∂
              fi
            fi
            
            echo "üìä Final Status Summary:"
            echo "   ‚Ä¢ Mergeable: $mergeable $([ "$force_merge" == true ] && echo "(force enabled)")"
            echo "   ‚Ä¢ Relevant checks passed: $all_checks_passed"
            echo "   ‚Ä¢ Review decision: $review_decision"
            echo "   ‚Ä¢ Relevant failed checks: $([ -n "$relevant_failed_checks" ] && echo "YES" || echo "NONE")"
            
            # ÂÜ≥ÂÆöÊòØÂê¶ÂêàÂπ∂
            can_merge=false
            
            if [[ "$mergeable" == "MERGEABLE" ]] && [[ "$all_checks_passed" == true ]]; then
              case "$review_decision" in
                "APPROVED"|"NONE"|"null"|"")
                  can_merge=true
                  ;;
                *)
                  echo "   ‚è∏Ô∏è Cannot merge: Review decision is '$review_decision'"
                  ;;
              esac
            fi
            
            if [[ "$can_merge" == true ]]; then
              echo "‚úÖ PR #$pr_number is ready for merge!"
              
              merge_message="Auto-merged PR #$pr_number"
              if [[ "$force_merge" == true ]]; then
                merge_message="$merge_message (self-reference bypass)"
              fi
              
              echo "üîÑ Attempting to merge PR #$pr_number..."
              echo "üìù Merge message: $merge_message"
              
              # Â∞ùËØïÂêàÂπ∂Ôºà‰ºòÂÖà‰ΩøÁî® squashÔºâ
              merge_success=false
              
              if gh pr merge $pr_number --squash --delete-branch --body "$merge_message" 2>/dev/null; then
                echo "üéâ Successfully squash merged PR #$pr_number and deleted branch"
                merge_success=true
              elif gh pr merge $pr_number --squash --body "$merge_message" 2>/dev/null; then
                echo "üéâ Successfully squash merged PR #$pr_number (branch not deleted)"
                merge_success=true
              elif gh pr merge $pr_number --merge --delete-branch --body "$merge_message" 2>/dev/null; then
                echo "üéâ Successfully merge committed PR #$pr_number and deleted branch"
                merge_success=true
              elif gh pr merge $pr_number --merge --body "$merge_message" 2>/dev/null; then
                echo "üéâ Successfully merge committed PR #$pr_number (branch not deleted)"
                merge_success=true
              fi
              
              if [[ "$merge_success" == false ]]; then
                echo "‚ùå All merge attempts failed for PR #$pr_number"
                echo "üí° Manual intervention may be required"
                
                # Â¶ÇÊûúÊòØÂº∫Âà∂ÂêàÂπ∂Â§±Ë¥•ÔºåÂ∞ùËØïÈáçÊñ∞Ëß¶ÂèëÊ£ÄÊü•
                if [[ "$force_merge" == true ]]; then
                  echo "üîÑ Force merge failed, trying to refresh PR status..."
                  # Ëß¶ÂèëÈáçÊñ∞ËÆ°ÁÆóÔºàÈÄöËøáÊ∑ªÂä†Ê†áÁ≠æÂÜçÁßªÈô§Ôºâ
                  gh pr edit $pr_number --add-label "auto-merge-retry" 2>/dev/null || true
                  sleep 2
                  gh pr edit $pr_number --remove-label "auto-merge-retry" 2>/dev/null || true
                fi
              fi
              
            else
              echo "‚è∏Ô∏è PR #$pr_number is not ready for auto-merge"
              
              if [[ -n "$relevant_failed_checks" ]] && [[ "$relevant_failed_checks" != "" ]]; then
                echo "   üî¥ Relevant failing checks:"
                echo "$relevant_failed_checks" | while IFS= read -r check; do
                  [[ -n "$check" ]] && echo "      - $check"
                done
              fi
              
              if [[ "$mergeable" != "MERGEABLE" ]] && [[ "$force_merge" != true ]]; then
                echo "   üî¥ Not mergeable: $mergeable"
              fi
            fi
            
            echo "================================================"
          done
          
          echo "üèÅ Auto-merge process completed"
