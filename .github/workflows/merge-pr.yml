name: Auto Merge Pull Requests
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  auto_merge:
    runs-on: ubuntu-latest
    
    # å¢åŠ æ›´å…¨é¢çš„æƒé™
    permissions:
      contents: write          # å†™å…¥ä»“åº“å†…å®¹
      pull-requests: write     # å†™å…¥PR
      checks: read            # è¯»å–æ£€æŸ¥çŠ¶æ€
      statuses: read          # è¯»å–çŠ¶æ€
      actions: read           # è¯»å–actionsçŠ¶æ€
      metadata: read          # è¯»å–ä»“åº“å…ƒæ•°æ®
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨ token è¿›è¡Œ checkoutï¼Œç¡®ä¿åç»­æ“ä½œæœ‰æƒé™
          token: ${{ github.token }}

      - name: Set up Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Auto merge PRs
        env:
          GH_TOKEN: ${{ github.token }}
          # æ·»åŠ  GitHub token ä½œä¸ºå¤‡ç”¨
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ” Getting all open pull requests..."
          
          # é¦–å…ˆéªŒè¯æƒé™
          echo "ğŸ” Checking GitHub CLI authentication..."
          gh auth status
          
          # è·å–æ‰€æœ‰å¼€æ”¾çš„PR
          prs=$(gh pr list --state open --json number,title,headRefName,author,baseRefName)
          
          if [[ "$prs" == "[]" ]]; then
            echo "â„¹ï¸ No open pull requests found."
            exit 0
          fi
          
          echo "ğŸ“‹ Found $(echo "$prs" | jq length) open PR(s)"
          
          # éå†æ¯ä¸ªPR
          echo "$prs" | jq -c '.[]' | while read -r pr; do
            pr_number=$(echo "$pr" | jq -r '.number')
            pr_title=$(echo "$pr" | jq -r '.title')
            pr_author=$(echo "$pr" | jq -r '.author.login')
            head_branch=$(echo "$pr" | jq -r '.headRefName')
            base_branch=$(echo "$pr" | jq -r '.baseRefName')
            
            echo "================================================"
            echo "ğŸ”„ Processing PR #$pr_number: $pr_title"
            echo "ğŸ‘¤ Author: $pr_author"
            echo "ğŸŒ¿ Branch: $head_branch â†’ $base_branch"
            
            # æ£€æŸ¥PRçŠ¶æ€
            echo "ğŸ” Checking PR status..."
            pr_status=$(gh pr view $pr_number --json mergeable,reviewDecision,statusCheckRollup)
            mergeable=$(echo "$pr_status" | jq -r '.mergeable')
            review_decision=$(echo "$pr_status" | jq -r '.reviewDecision')
            
            # æ£€æŸ¥CIçŠ¶æ€
            echo "ğŸ§ª Checking CI status..."
            all_checks_passed=true
            
            # æ£€æŸ¥çŠ¶æ€æ£€æŸ¥
            status_rollup=$(echo "$pr_status" | jq -r '.statusCheckRollup[]?.conclusion' 2>/dev/null || echo "")
            
            if [[ -n "$status_rollup" ]]; then
              while IFS= read -r status; do
                if [[ "$status" != "SUCCESS" ]] && [[ "$status" != "NEUTRAL" ]] && [[ "$status" != "SKIPPED" ]] && [[ -n "$status" ]] && [[ "$status" != "null" ]]; then
                  all_checks_passed=false
                  echo "âŒ Found failing status: $status"
                  break
                fi
              done <<< "$status_rollup"
            fi
            
            # é¢å¤–æ£€æŸ¥ï¼šä½¿ç”¨ gh pr checks å‘½ä»¤
            pr_checks=$(gh pr checks $pr_number --json conclusion,name 2>/dev/null || echo "[]")
            
            if [[ "$pr_checks" != "[]" ]]; then
              failed_checks=$(echo "$pr_checks" | jq -r '.[] | select(.conclusion != "SUCCESS" and .conclusion != "SKIPPED" and .conclusion != "NEUTRAL" and .conclusion != null) | .name' 2>/dev/null || echo "")
              
              if [[ -n "$failed_checks" ]]; then
                all_checks_passed=false
                echo "âŒ Failed checks found:"
                echo "$failed_checks" | while IFS= read -r check; do
                  echo "   - $check"
                done
              fi
            fi
            
            echo "ğŸ“Š Status Summary:"
            echo "   â€¢ Mergeable: $mergeable"
            echo "   â€¢ All checks passed: $all_checks_passed"
            echo "   â€¢ Review decision: $review_decision"
            
            # æ£€æŸ¥åˆå¹¶æ¡ä»¶
            if [[ "$mergeable" == "MERGEABLE" ]] && [[ "$all_checks_passed" == true ]]; then
              echo "âœ… PR is ready for merge!"
              
              # å°è¯•åˆå¹¶ï¼Œæ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†
              echo "ğŸ”„ Attempting to merge PR #$pr_number..."
              
              # æ£€æŸ¥æ˜¯å¦æ˜¯å—ä¿æŠ¤çš„åˆ†æ”¯
              protected_branches=("main" "master" "develop" "staging")
              is_protected=false
              
              for protected in "${protected_branches[@]}"; do
                if [[ "$head_branch" == "$protected" ]] || [[ "$head_branch" == "$base_branch" ]]; then
                  is_protected=true
                  break
                fi
              done
              
              # å°è¯•åˆå¹¶
              if [[ "$is_protected" == true ]]; then
                echo "âš ï¸ Protected branch detected: $head_branch"
                echo "ğŸ”„ Merging without deleting branch..."
                if gh pr merge $pr_number --squash; then
                  echo "ğŸ‰ Successfully merged PR #$pr_number"
                else
                  echo "âŒ Failed to merge PR #$pr_number"
                  echo "ğŸ’¡ This might be due to branch protection rules or insufficient permissions"
                fi
              else
                echo "ğŸ”„ Merging and deleting feature branch: $head_branch"
                if gh pr merge $pr_number --squash --delete-branch; then
                  echo "ğŸ‰ Successfully merged PR #$pr_number"
                else
                  echo "âŒ Failed to merge PR #$pr_number"
                  echo "ğŸ’¡ Trying merge without deleting branch..."
                  if gh pr merge $pr_number --squash; then
                    echo "ğŸ‰ Successfully merged PR #$pr_number (branch not deleted)"
                  else
                    echo "âŒ Failed to merge PR #$pr_number completely"
                  fi
                fi
              fi
              
            else
              echo "â¸ï¸ PR #$pr_number is not ready for auto-merge"
              
              # è¯¦ç»†çš„é˜»å¡åŸå› 
              if [[ "$mergeable" != "MERGEABLE" ]]; then
                case "$mergeable" in
                  "CONFLICTING")
                    echo "   ğŸ”´ Reason: Merge conflicts detected"
                    ;;
                  "UNKNOWN")
                    echo "   ğŸŸ¡ Reason: Merge status unknown (may be calculating)"
                    ;;
                  *)
                    echo "   ğŸ”´ Reason: Not mergeable ($mergeable)"
                    ;;
                esac
              fi
              
              if [[ "$all_checks_passed" != true ]]; then
                echo "   ğŸ”´ Reason: Some status checks are failing"
              fi
              
              if [[ "$review_decision" == "REVIEW_REQUIRED" ]]; then
                echo "   ğŸ”´ Reason: Review required"
              elif [[ "$review_decision" == "CHANGES_REQUESTED" ]]; then
                echo "   ğŸ”´ Reason: Changes requested"
              fi
            fi
            
            echo "================================================"
          done
