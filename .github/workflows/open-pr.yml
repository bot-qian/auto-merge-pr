name: Auto Run Script and Create PR
on:
  schedule:
    - cron: "0 2 * * *" # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  run_script_and_create_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.BOT_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            npm ci
          elif [ -f package-lock.json ]; then
            npm install
          else
            echo "No package.json found, skipping npm install"
          fi

      - name: Set up Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions Bot"

      - name: Run commit script and create PR
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_TOKEN }}
          TARGET_REPO: "bot-qian/auto-merge-pr" # ç›®æ ‡ä»“åº“
        run: |
          echo "ğŸš€ Starting automated script execution and PR creation..."

          # ç”Ÿæˆå”¯ä¸€çš„åˆ†æ”¯å
          timestamp=$(date +%Y%m%d-%H%M%S)
          branch_name="auto-update-${timestamp}"

          echo "ğŸ“ Running commit script..."
          # è¿è¡Œæ‚¨çš„è„šæœ¬
          if node scripts/commit.js; then
            echo "âœ… Script executed successfully"
          else
            echo "âŒ Script execution failed"
            exit 1
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
          if [[ -n $(git status --porcelain) ]]; then
            echo "ğŸ“ Changes detected, proceeding with PR creation..."
            
            # åˆ‡æ¢åˆ°æ–°åˆ†æ”¯
            git checkout -b $branch_name
            
            # æ·»åŠ æ‰€æœ‰å˜æ›´
            git add ./images
            
            # æäº¤å˜æ›´
            commit_message="chore: automated update - $(date '+%Y-%m-%d %H:%M:%S')"
            git commit -m "$commit_message"
            
            # æ¨é€åˆ†æ”¯åˆ°è¿œç¨‹
            git push origin $branch_name
            
            # åˆ›å»º Pull Request
            pr_title="ğŸ¤– Automated Update - $(date '+%Y-%m-%d')"
            pr_body="This PR was automatically created by GitHub Actions.

            ## Changes
            - Executed \`node scripts/commit.js\`
            - Generated on: $(date '+%Y-%m-%d %H:%M:%S UTC')
            
            ## Auto-merge
            This PR can be automatically merged if all checks pass.
            
            ---
            *Created by [GitHub Actions](https://github.com/${{ github.repository }}/actions)*"
            
            # åˆ›å»ºPRå¹¶æ·»åŠ auto-mergeæ ‡ç­¾
            pr_url=$(gh pr create \
              --repo "$TARGET_REPO" \
              --base main \
              --head $branch_name \
              --title "$pr_title" \
              --body "$pr_body" \
              --label "auto-merge,automated")
            
            echo "âœ… Pull Request created: $pr_url"
            
            # å¯é€‰ï¼šç«‹å³å¯ç”¨auto-merge
            pr_number=$(echo "$pr_url" | grep -o '[0-9]*$')
            echo "ğŸ”„ Enabling auto-merge for PR #$pr_number"
            
            # ç­‰å¾…ä¸€ä¸‹è®©GitHubå¤„ç†PRåˆ›å»º
            sleep 5
            
            # å¯ç”¨auto-merge (éœ€è¦ä»“åº“å¯ç”¨äº†auto-mergeåŠŸèƒ½)
            gh pr merge $pr_number --auto --squash --repo "$TARGET_REPO" || echo "âš ï¸ Auto-merge not available, PR will need manual merge"
            
          else
            echo "â„¹ï¸ No changes detected after running script, skipping PR creation"
          fi
