name: Auto Run Script and Create PR
on:
  schedule:
    - cron: "0 2 * * *" # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  run_script_and_create_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.BOT_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          # ä½¿ç”¨ yarn ç¼“å­˜
          cache: "yarn"

      - name: Setup Yarn
        run: |
          # ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„ Yarn
          corepack enable
          yarn --version

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies with Yarn..."
          if [ -f yarn.lock ]; then
            echo "âœ… Found yarn.lock, using Yarn"
            yarn install --frozen-lockfile
          elif [ -f package.json ]; then
            echo "âš ï¸ No yarn.lock found, creating one"
            yarn install
          else
            echo "âŒ No package.json found"
            exit 1
          fi

      - name: Verify script exists
        run: |
          if [ ! -f "scripts/commit.js" ]; then
            echo "âŒ Script scripts/commit.js not found!"
            exit 1
          fi
          echo "âœ… Script file exists"

      - name: Set up Git
        run: |
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Run commit script and create PR
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.BOT_TOKEN }}
          TARGET_REPO: "bot-qian/auto-merge-pr" # ç›®æ ‡ä»“åº“
        run: |
          echo "ğŸš€ Starting automated script execution and PR creation..."

          # ç”Ÿæˆå”¯ä¸€çš„åˆ†æ”¯å
          timestamp=$(date +%Y%m%d-%H%M%S)
          random_suffix=$(openssl rand -hex 3)
          branch_name="auto-update-${timestamp}-${random_suffix}"

          echo "ğŸ“ Running commit script..."
          
          # è®°å½•æ‰§è¡Œå‰çš„çŠ¶æ€
          echo "ğŸ“‹ Files before script execution:"
          git status --porcelain
          
          # è¿è¡Œæ‚¨çš„è„šæœ¬ï¼Œæ·»åŠ è¶…æ—¶ä¿æŠ¤
          if timeout 300 node scripts/commit.js; then
            echo "âœ… Script executed successfully"
          else
            echo "âŒ Script execution failed or timed out"
            exit 1
          fi

          # è®°å½•æ‰§è¡Œåçš„çŠ¶æ€
          echo "ğŸ“‹ Files after script execution:"
          git status --porcelain

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
          changes=$(git status --porcelain)
          if [[ -n "$changes" ]]; then
            echo "ğŸ“ Changes detected, proceeding with PR creation..."
            
            # æ˜¾ç¤ºå˜æ›´è¯¦æƒ…
            echo "ğŸ“Š Changed files:"
            echo "$changes"
            
            # åˆ‡æ¢åˆ°æ–°åˆ†æ”¯
            git checkout -b $branch_name
            
            # æ·»åŠ å˜æ›´ - æ‚¨å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹è¿™é‡Œ
            git add ./images
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å·²æš‚å­˜çš„æ–‡ä»¶
            staged_files=$(git diff --cached --name-only)
            if [[ -z "$staged_files" ]]; then
              echo "âš ï¸ No files were staged for commit"
              echo "Adding all changes..."
              git add .
            fi
            
            # ç»Ÿè®¡å˜æ›´
            added_files=$(git diff --cached --name-only --diff-filter=A | wc -l)
            modified_files=$(git diff --cached --name-only --diff-filter=M | wc -l)
            deleted_files=$(git diff --cached --name-only --diff-filter=D | wc -l)
            
            # æäº¤å˜æ›´
            commit_message="ğŸ¤– chore: automated update - $(date '+%Y-%m-%d %H:%M:%S')

          ğŸ“Š Changes:
          â€¢ Added: ${added_files} files
          â€¢ Modified: ${modified_files} files
          â€¢ Deleted: ${deleted_files} files
          
          ğŸ”§ Generated by: scripts/commit.js
          ğŸ“… Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')
          ğŸƒ Workflow: ${{ github.workflow }}
          ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            
            git commit -m "$commit_message"
            
            # æ¨é€åˆ†æ”¯åˆ°è¿œç¨‹
            echo "â¬†ï¸ Pushing branch to origin..."
            git push origin $branch_name
            
            # ç­‰å¾…åˆ†æ”¯åŒæ­¥
            sleep 3
            
            # åˆ›å»º Pull Request
            pr_title="ğŸ¤– Automated Update - $(date '+%Y-%m-%d %H:%M')"
            pr_body="## ğŸ¤– Automated Update Report

          **Generated:** $(date '+%Y-%m-%d %H:%M:%S UTC')  
          **Workflow:** [\`${{ github.workflow }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})  
          **Repository:** ${{ github.repository }}

          ### ğŸ“Š Changes Summary
          - **Added Files:** ${added_files}
          - **Modified Files:** ${modified_files}
          - **Deleted Files:** ${deleted_files}

          ### ğŸ”§ Executed Scripts
          - \`node scripts/commit.js\`

          ### ğŸ“ Changed Files
          \`\`\`
          $changes
          \`\`\`

          ### ğŸš€ Auto-Merge Configuration
          This PR is configured for automatic merging when all checks pass.

          ---
          *This PR was automatically generated by [GitHub Actions](${{ github.server_url }}/${{ github.repository }}) ğŸš€*"
            
            echo "ğŸ“ Creating Pull Request..."
            
            # åˆ›å»ºPRï¼ˆä¸æ·»åŠ æ ‡ç­¾ï¼‰
            pr_url=$(gh pr create \
              --repo "$TARGET_REPO" \
              --base main \
              --head "${{ github.repository_owner }}:$branch_name" \
              --title "$pr_title" \
              --body "$pr_body")
            
            if [[ -n "$pr_url" ]]; then
              echo "âœ… Pull Request created: $pr_url"
              
              # æå–PRå·ç 
              pr_number=$(echo "$pr_url" | grep -o '[0-9]*$')
              echo "ğŸ“‹ PR Number: #$pr_number"
              
              # ç­‰å¾…GitHubå¤„ç†PR
              echo "â³ Waiting for GitHub to process the PR..."
              sleep 10
              
              # æ£€æŸ¥ç›®æ ‡ä»“åº“æ˜¯å¦æœ‰å¯ç”¨çš„æ ‡ç­¾ï¼Œå¹¶å°è¯•æ·»åŠ 
              echo "ğŸ·ï¸ Checking available labels..."
              available_labels=$(gh label list --repo "$TARGET_REPO" --json name -q '.[].name' | tr '\n' ' ')
              echo "Available labels: $available_labels"
              
              # å°è¯•æ·»åŠ æ ‡ç­¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              if echo "$available_labels" | grep -q "auto-merge"; then
                echo "Adding auto-merge label..."
                gh pr edit $pr_number --add-label "auto-merge" --repo "$TARGET_REPO" || echo "âš ï¸ Could not add auto-merge label"
              fi
              
              if echo "$available_labels" | grep -q "automated"; then
                echo "Adding automated label..."
                gh pr edit $pr_number --add-label "automated" --repo "$TARGET_REPO" || echo "âš ï¸ Could not add automated label"
              fi
              
              if echo "$available_labels" | grep -q "bot-generated"; then
                echo "Adding bot-generated label..."
                gh pr edit $pr_number --add-label "bot-generated" --repo "$TARGET_REPO" || echo "âš ï¸ Could not add bot-generated label"
              fi
              
              # å°è¯•å¯ç”¨auto-merge
              echo "ğŸ”„ Attempting to enable auto-merge..."
              if gh pr merge $pr_number --auto --squash --repo "$TARGET_REPO"; then
                echo "âœ… Auto-merge enabled successfully!"
                echo "ğŸ¯ PR will be merged automatically when all checks pass"
              else
                echo "âš ï¸ Could not enable auto-merge"
                echo "ğŸ’¡ This might be because:"
                echo "   â€¢ Repository doesn't have auto-merge enabled"
                echo "   â€¢ PR requires manual review"
                echo "   â€¢ Branch protection rules require admin approval"
                echo "   â€¢ Auto-merge feature is not available for this repository"
              fi
              
              # æ£€æŸ¥æœ€ç»ˆçš„auto-mergeçŠ¶æ€
              echo "ğŸ” Checking auto-merge status..."
              auto_merge_status=$(gh pr view $pr_number --repo "$TARGET_REPO" --json autoMergeRequest -q '.autoMergeRequest')
              if [[ "$auto_merge_status" != "null" ]]; then
                auto_merge_enabled="âœ…"
              else
                auto_merge_enabled="âŒ"
              fi
              
              # è¾“å‡ºæœ€ç»ˆçŠ¶æ€
              echo "ğŸ‰ Automation completed successfully!"
              echo "ğŸ“Š Summary:"
              echo "   â€¢ Script executed: âœ…"
              echo "   â€¢ Changes committed: âœ…"
              echo "   â€¢ PR created: âœ…"
              echo "   â€¢ Auto-merge: $auto_merge_enabled"
              echo "   â€¢ PR URL: $pr_url"
              
            else
              echo "âŒ Failed to create Pull Request"
              exit 1
            fi
            
          else
            echo "â„¹ï¸ No changes detected after running script"
            echo "ğŸ” Possible reasons:"
            echo "   â€¢ Script didn't modify any files"
            echo "   â€¢ All changes were already committed"
            echo "   â€¢ Script ran but produced no output"
            echo "ğŸ’¡ This is normal and not an error"
          fi

      - name: Cleanup on failure
        if: failure()
        run: |
          echo "ğŸ§¹ Cleaning up on failure..."
          # åˆ é™¤å¯èƒ½åˆ›å»ºçš„æœ¬åœ°åˆ†æ”¯
          current_branch=$(git branch --show-current)
          if [[ "$current_branch" == auto-update-* ]]; then
            git checkout main
            git branch -D "$current_branch" || true
          fi
          
          # åˆ é™¤è¿œç¨‹åˆ†æ”¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if git ls-remote --heads origin | grep -q "auto-update-"; then
            remote_branches=$(git ls-remote --heads origin | grep "auto-update-" | awk '{print $2}' | sed 's|refs/heads/||')
            for branch in $remote_branches; do
              git push origin --delete "$branch" || true
            done
          fi
